#!/bin/bash

IFS=$'\n'       # Prevent "for" loop splitting filenames on whitespace
declare -A SUB  # Initialise associative array to store subtotals

stripc() {
    awk -vRS='*/' '{gsub(/\/\*.*/,"")}1' $1 | sed -r '/^(\s|[{}])*$/d'
}

stripxml() {
    awk -vRS='-->' '{gsub(/<!--.*/,"")}1' $1 | sed '/^\s*$/d'
}

print() {
    printf "  | %-13s | %'8d |\n" $*
}

count() {
    case $2 in
    AWK|CoffeeScript|Make|Perl|Python|Sed|Shell|TCL)
        let SUB[$2]+=$(sed -r '/^\s*(#|$)/d' $1 | wc -l);;
    Ruby)
        let SUB[$2]+=$(sed -r '/^\s*(#|$)/d;/^=begin$/,/^=end$/d' $1 | wc -l);;
    C|CSS|JavaScript|Vala)
        let SUB[$2]+=$(stripc $1 | wc -l);;
    SQL|Lua)
        let SUB[$2]+=$(sed -r '/^\s*(\-\-|$)/d' $1 | wc -l);;
    HTML|Mallard|XML)
        let SUB[$2]+=$(stripxml $1 | wc -l);;
    esac
}

for F in $(find $@ -type f -not -path "*/.*"); do
    case $F in
        *.awk)              count $F AWK;;
        *.c|*.h)            count $F C;;
        *.coffee)           count $F CoffeeScript;;
        *.css)              count $F CSS;;
        *.html)             count $F HTML;;
        *.lua)              count $F Lua;;
        *.page)             count $F Mallard;;
        *.js)               count $F JavaScript;;
        *.perl|*.pl|*.pm)   count $F Perl;;
        *.py)               count $F Python;;
        *.rb)               count $F Ruby;;
        *.sed)              count $F Sed;;
        *.sql)              count $F SQL;;
        *.svg)              ;; # Don't count SVG images in XML subtotal
        *.tcl)              count $F TCL;;
        *.vala)             count $F Vala;;
        *.xml|*.ui|*.glade) count $F XML;;
        *.??sh)             count $F Shell;;
        *[Mm]akefile|*.mk)  count $F Make;;
        *) case "$(sed -rn '1s|(\#!.*/(env\s*)?)?(.*)|\3|p' $F)" in
            awk*)           count $F AWK;;
            coffee*)        count $F CoffeeScript;;
            lua*)           count $F Lua;;
            perl*)          count $F Perl;;
            python*)        count $F Python;;
            ruby*)          count $F Ruby;;
            sed*)           count $F Sed;;
            *html*)         count $F HTML;;
            *mallard*)      count $F Mallard;;
            *xml*)          count $F XML;;
            ??sh*)          count $F Shell;;
        esac;;
    esac
done

if test ${#SUB[@]} -eq 0; then echo "Nothing to count" >&2; exit; fi

echo
echo '  +---------------+----------+'
echo '  | Language      |    Lines |'
echo '  +---------------+----------+'

for LANGUAGE in ${!SUB[@]}; do
    print $LANGUAGE: ${SUB[$LANGUAGE]}
    let TOTAL+=${SUB[$LANGUAGE]}
done

echo '  +---------------+----------+'
print     Total:            $TOTAL
echo '  +---------------+----------+'
echo
